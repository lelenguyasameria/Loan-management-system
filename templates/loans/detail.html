{% extends 'base.html' %}

{% block title %}Loan #{{ loan.id }} Details - Loan Management System{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>Loan #{{ loan.id }} Details</h2>
        <span class="status-badge status-{{ loan.status }}">{{ loan.get_status_display }}</span>
    </div>
    
    <div class="grid grid-2">
        <div>
            <h3>Loan Information</h3>
            <p><strong>Loan Amount:</strong> ${{ loan.amount|floatformat:2 }}</p>
            <p><strong>Interest Rate:</strong> {{ loan.interest_rate }}% per annum</p>
            <p><strong>Application Date:</strong> {{ loan.created_at|date:"M d, Y g:i A" }}</p>
            <p><strong>Due Date:</strong> {{ loan.due_date|date:"M d, Y" }}</p>
            <p><strong>Current Status:</strong> 
                <span class="status-badge status-{{ loan.status }}">{{ loan.get_status_display }}</span>
            </p>
        </div>
        
        <div>
            <h3>Borrower Information</h3>
            <p><strong>Name:</strong> {{ loan.user.username }}</p>
            <p><strong>Phone:</strong> {{ loan.user.phone_number }}</p>
            <p><strong>National ID:</strong> {{ loan.user.national_id }}</p>
        </div>
    </div>
    
    {% if loan.status == 'approved' %}
    <div class="card" style="background-color: #d4edda; border: 1px solid #c3e6cb;">
        <h3>Loan Approved!</h3>
        <p>Your loan has been approved. You can now make payments towards this loan.</p>
        <a href="{% url 'repayment_make' loan.id %}" class="btn btn-success">Make a Payment</a>
    </div>
    {% elif loan.status == 'pending' %}
    <div class="card" style="background-color: #fff3cd; border: 1px solid #ffeaa7;">
        <h3>Application Under Review</h3>
        <p>Your loan application is currently being reviewed. We'll notify you once a decision has been made.</p>
    </div>
    {% elif loan.status == 'rejected' %}
    <div class="card" style="background-color: #f8d7da; border: 1px solid #f5c6cb;">
        <h3>Application Rejected</h3>
        <p>Unfortunately, your loan application was not approved. You may apply for a new loan with different terms.</p>
        <a href="{% url 'loan_apply' %}" class="btn">Apply for New Loan</a>
    </div>
    {% elif loan.status == 'repaid' %}
    <div class="card" style="background-color: #d1ecf1; border: 1px solid #b8daff;">
        <h3>Loan Completed</h3>
        <p>Congratulations! This loan has been fully repaid.</p>
    </div>
    {% endif %}
</div>

{% if repayments %}
<div class="card">
    <h3>Payment History</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Payment ID</th>
                <th>Amount Paid</th>
                <th>Payment Date</th>
                <th>Remaining Balance</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in repayments %}
            <tr>
                <td>#{{ payment.id }}</td>
                <td>${{ payment.amount_paid|floatformat:2 }}</td>
                <td>{{ payment.payment_date|date:"M d, Y g:i A" }}</td>
                <td>${{ payment.remaining_balance|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div style="margin-top: 1rem;">
        <strong>Total Paid: ${{ total_paid|floatformat:2 }}</strong> | 
        <strong>Remaining: ${{ remaining_balance|floatformat:2 }}</strong>
    </div>
</div>
{% else %}
<div class="card">
    <h3>Payment History</h3>
    <p>No payments have been made for this loan yet.</p>
    {% if loan.status == 'approved' %}
        <a href="{% url 'repayment_make' loan.id %}" class="btn btn-success">Make First Payment</a>
    {% endif %}
</div>
{% endif %}

<div style="margin-top: 2rem;">
    <a href="{% url 'loan_list' %}" class="btn">Back to My Loans</a>
    <a href="{% url 'dashboard' %}" class="btn">Dashboard</a>
</div>
{% endblock %}